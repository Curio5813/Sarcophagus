{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load widget_tweaks %}
{% block content %}
{% include 'latest_news.html' %}

<div class="game-detail-container">
    <h1>{{ game.game }}</h1>

    <div class="game-media-wrapper">
        <div class="game-cover">
            <img src="{{ game.imagem.url }}" alt="{{ game.game }}">
        </div>

        {% if game.embed_video_url %}
        <div class="video-container">
            <iframe src="{{ game.embed_video_url }}" allowfullscreen></iframe>
        </div>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
    <div class="rating-favorite-box">
        <p><strong>Favorite:</strong>
            <span class="favorite-btn {% if game.user_favorito %}active{% endif %}" data-game-id="{{ game.id }}">
                <i class="{% if game.user_favorito %}fas{% else %}far{% endif %} fa-heart"></i>
            </span>
        </p>

        <p><strong>Rate this game:</strong></p>
        <div class="star-rating" data-game-id="{{ game.id }}" data-current-rating="{{ game.user_rating|default:0 }}">
            {% for i in "12345" %}
            <span class="star {% if game.user_rating >= i|add:'0'|mul:2 %}active{% endif %}" data-value="{{ i }}">
                <i class="fa fa-star"></i>
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="game-meta">
        <p><strong>Year:</strong> {{ game.ano }}</p>
        <p><strong>Genre:</strong>
            {% for genero in game.generos.all %}
                {{ genero.nome }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </p>
        <p><strong>Developer:</strong> {{ game.desenvolvedor }}</p>
        <p><strong>Publisher:</strong> {{ game.distribuidor }}</p>
    </div>

    <div class="game-details-text">
        <h3>Review</h3>
        <p>{{ game.descricao }}</p>

        <h3>Gameplay</h3>
        <p>{{ game.gameplay }}</p>

        <h3>Graphics</h3>
        <p>{{ game.graphics }}</p>

        <h3>Sound and Music</h3>
        <p>{{ game.sound_and_music }}</p>

        <h3>Conclusion</h3>
        <p>{{ game.conclusion }}</p>
    </div>

    <!-- Caixa de comentários -->
    <div class="comment-box">
        <h3>Comments</h3>

        {% if user.is_authenticated %}
        <form method="post" id="game-comment-form" action="{{ request.path }}">
            {% csrf_token %}
            <textarea name="comentario" id="comentario-input" class="form-control" placeholder="Your comment..." required></textarea>
            <button type="submit" class="site-btn" id="send-comment-btn">Send Comment</button>
        </form>
        {% else %}
        <p>You need <a href="{% url 'login' %}">to login</a> to comment.</p>
        {% endif %}

        <hr style="margin: 20px 0;">

        <div id="comentarios-container">
            {% for comentario in comentarios %}
                {{ comentario.comentario }}
                <div class="comment-item" data-id="{{ comentario.id }}">
                    <p>
                        <strong><a href="{% url 'membro-details' comentario.membro.id %}">{{ comentario.membro }}</a></strong>:
                        <span class="comentario-text">{{ comentario.comentario }}</span>
                    </p>
                    <p><small>
                        {% if comentario.publicado_em|timesince == "0 minutes" %}
                            Agora mesmo
                        {% else %}
                            {{ comentario.publicado_em|timesince }} atrás
                        {% endif %}
                    </small></p>

                    <div class="comment-actions">
                        <button class="like-btn" data-id="{{ comentario.id }}">
                            <i class="fa fa-heart"></i> <span class="like-count">{{ comentario.likes.count }}</span>
                        </button>
                        <button class="reply-btn" data-id="{{ comentario.id }}">Reply</button>

                        {% if user == comentario.membro %}
                            <button class="edit-btn" data-id="{{ comentario.id }}">Edit</button>
                            <button class="delete-btn" data-id="{{ comentario.id }}">Delete</button>
                        {% endif %}
                    </div>

                    <div id="replies-{{ comentario.id }}" class="replies">
                        {% for resposta in comentario.respostas.all %}
                            <div class="reply-item">
                                <p><strong><a href="{% url 'membro-details' resposta.membro.id %}">{{ resposta.membro }}</a></strong>: {{ resposta.comentario }}</p>
                                <p><small>
                                    {% if resposta.publicado_em|timesince == "0 minutes" %}
                                        Agora mesmo
                                    {% else %}
                                        {{ resposta.publicado_em|timesince }} atrás
                                    {% endif %}
                                </small></p>
                            </div>
                        {% endfor %}
                    </div>

                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // FAVORITAR JOGO
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const gameId = this.dataset.gameId;
            const isFavorited = this.classList.contains('active');

            fetch("{% url 'favoritar_jogo' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ game_id: gameId, favorito: !isFavorited })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.classList.toggle('active');
                    this.querySelector('i').classList.toggle('far');
                    this.querySelector('i').classList.toggle('fas');
                }
            });
        });
    });

    // AVALIAR JOGO
    document.querySelectorAll('.star-rating .star').forEach(star => {
        star.addEventListener('click', function () {
            const rating = parseInt(this.dataset.value) * 2;
            const gameId = this.closest('.star-rating').dataset.gameId;

            fetch("{% url 'avaliar_jogo' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ game_id: gameId, rating: rating })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const allStars = star.closest('.star-rating').querySelectorAll('.star');
                    allStars.forEach(s => {
                        if (parseInt(s.dataset.value) <= rating / 2) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                }
            });
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function ativarAcoesComentarios() {
        // Curtir comentário
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.onclick = function () {
                const id = this.dataset.id;
                fetch(`/comentario/${id}/curtir/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.querySelector('.like-count').textContent = data.likes;
                    }
                });
            };
        });

        // Responder comentário
        document.querySelectorAll('.reply-btn').forEach(btn => {
            btn.onclick = function () {
                const commentId = this.dataset.id;
                const replyContainer = document.getElementById(`replies-${commentId}`);
                let replyBox = replyContainer.querySelector('.reply-box');

                if (replyBox) {
                    replyBox.remove();
                } else {
                    replyBox = document.createElement('div');
                    replyBox.className = 'reply-box';
                    replyBox.innerHTML = `
                        <textarea class="form-control" placeholder="Reply..." style="margin-top:10px;"></textarea>
                        <button class="site-btn" style="margin-top:5px;">Send Reply</button>
                    `;

                    const textarea = replyBox.querySelector('textarea');
                    const sendButton = replyBox.querySelector('button');

                    sendButton.onclick = function () {
                        const text = textarea.value.trim();
                        if (text) {
                            fetch(`/comentario/${commentId}/responder/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-CSRFToken': csrftoken
                                },
                                body: new URLSearchParams({ comentario: text })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const replyItem = `
                                        <div class="reply-item">
                                            <p><strong>${data.membro}</strong>: ${data.comentario}</p>
                                            <p><small>${data.tempo}</small></p>
                                        </div>
                                    `;
                                    replyContainer.insertAdjacentHTML('afterbegin', replyItem);
                                    replyBox.remove();
                                }
                            });
                        }
                    };

                    replyContainer.prepend(replyBox);
                }
            };
        });

       // Editar comentário
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.onclick = function () {
                const commentId = this.dataset.id;
                const commentText = document.querySelector(`.comment-item[data-id="${commentId}"] .comentario-text`);

                // ⚡ Verifica se já tem um textarea (já está editando)
                if (commentText.querySelector('textarea')) {
                    return; // se já está editando, não faz nada
                }

                const originalText = commentText.textContent.trim();

                const textarea = document.createElement('textarea');
                textarea.className = 'form-control';
                textarea.value = originalText;

                // Criar container para os botões
                const actionsDiv = document.createElement('div');
                actionsDiv.style.display = 'flex';
                actionsDiv.style.gap = '10px';
                actionsDiv.style.marginTop = '5px';

                const saveBtn = document.createElement('button');
                saveBtn.className = 'site-btn';
                saveBtn.textContent = 'Save';

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'site-btn';
                cancelBtn.textContent = 'Cancel';

                commentText.innerHTML = '';
                commentText.appendChild(textarea);
                commentText.appendChild(actionsDiv);
                actionsDiv.appendChild(saveBtn);
                actionsDiv.appendChild(cancelBtn);

                saveBtn.onclick = function () {
                    const newText = textarea.value.trim();
                    fetch(`/comentario/${commentId}/editar/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrftoken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: new URLSearchParams({ comentario: newText })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            commentText.innerHTML = newText;
                        }
                    });
                };

                cancelBtn.onclick = function () {
                    commentText.innerHTML = originalText;
                };
            };
        });

        // Excluir comentário
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = function () {
                if (confirm("Are you sure you want to delete this comment?")) {
                    const commentId = this.dataset.id;
                    fetch(`/comentario/${commentId}/excluir/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.querySelector(`.comment-item[data-id="${commentId}"]`).remove();
                        }
                    });
                }
            };
        });
    }

    ativarAcoesComentarios();

    // Enviar novo comentário
    const commentForm = document.getElementById('game-comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const comentarioInput = document.getElementById('comentario-input');
            const text = comentarioInput.value.trim();

            if (!text) return;

            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ comentario: text })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const comentariosContainer = document.getElementById('comentarios-container');
                    const newComment = `
                        <div class="comment-item" data-id="${data.id}">
                            <p>
                                <strong><a href="${data.membro_url}">${data.membro}</a></strong>:
                                <span class="comentario-text">${data.comentario}</span>
                            </p>
                            <p><small>${data.tempo}</small></p>
                            <div class="comment-actions">
                                <button class="like-btn" data-id="${data.id}">
                                    <i class="fa fa-heart"></i> <span class="like-count">0</span>
                                </button>
                                <button class="reply-btn" data-id="${data.id}">Reply</button>
                                <button class="edit-btn" data-id="${data.id}">Edit</button>
                                <button class="delete-btn" data-id="${data.id}">Delete</button>
                            </div>
                            <div id="replies-${data.id}" class="replies"></div>
                        </div>
                    `;
                    comentariosContainer.insertAdjacentHTML('afterbegin', newComment);
                    comentarioInput.value = '';
                    ativarAcoesComentarios();
                }
            });
        });
    }
});
</script>

{% include 'footer.html' %}
{% endblock %}
