{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load widget_tweaks %}
{% block content %}
{% include 'latest_news.html' %}

<div class="game-detail-container">
    <h1>{{ game.game }}</h1>

    <div class="game-media-wrapper">
        <div class="game-cover">
            <img src="{{ game.imagem.url }}" alt="{{ game.game }}">
        </div>

        {% if game.embed_video_url %}
        <div class="video-container">
            <iframe src="{{ game.embed_video_url }}" allowfullscreen></iframe>
        </div>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
    <div class="rating-favorite-box">
        <p><strong>Favorite:</strong>
            <span class="favorite-btn {% if game.user_favorito %}active{% endif %}" data-game-id="{{ game.id }}">
                <i class="{% if game.user_favorito %}fas{% else %}far{% endif %} fa-heart"></i>
            </span>
        </p>

        <p><strong>Rate this game:</strong></p>
        <div class="star-rating" data-game-id="{{ game.id }}" data-current-rating="{{ game.user_rating|default:0 }}">
            {% for i in "12345" %}
            <span class="star {% if game.user_rating >= i|add:'0'|mul:2 %}active{% endif %}" data-value="{{ i }}">
                <i class="fa fa-star"></i>
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="game-meta">
        <p><strong>Year:</strong> {{ game.ano }}</p>
        <p><strong>Genre:</strong>
            {% for genero in game.generos.all %}
                {{ genero.nome }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </p>
        <p><strong>Developer:</strong> {{ game.desenvolvedor }}</p>
        <p><strong>Publisher:</strong> {{ game.distribuidor }}</p>
    </div>

    <div class="game-details-text">
        <h3>Review</h3>
        <p>{{ game.descricao }}</p>

        <h3>Gameplay</h3>
        <p>{{ game.gameplay }}</p>

        <h3>Graphics</h3>
        <p>{{ game.graphics }}</p>

        <h3>Sound and Music</h3>
        <p>{{ game.sound_and_music }}</p>

        <h3>Conclusion</h3>
        <p>{{ game.conclusion }}</p>
    </div>

    <!-- Caixa de coment치rios -->
    <div class="comment-box">
        <h3>Comments</h3>

        {% if user.is_authenticated %}
        <form method="post" id="game-comment-form">
            {% csrf_token %}
            <textarea name="comentario" id="comentario-input" class="form-control" placeholder="Your comment..." required></textarea>
            <button type="submit" class="site-btn" id="send-comment-btn">Send Comment</button>
        </form>
        {% else %}
        <p>You need <a href="{% url 'login' %}">to login</a> to comment.</p>
        {% endif %}

        <hr style="margin: 20px 0;">

        <div id="comentarios-container">
            {% for comentario in comentarios %}
                {{ comentario.comentario }}
                <div class="comment-item" data-id="{{ comentario.id }}">
                    <p>
                        <strong><a href="{% url 'membro-details' comentario.membro.id %}">{{ comentario.membro }}</a></strong>:
                        <span class="comentario-text">{{ comentario.comentario }}</span>
                    </p>
                    <p><small>
                        {% if comentario.publicado_em|timesince == "0 minutes" %}
                            Agora mesmo
                        {% else %}
                            {{ comentario.publicado_em|timesince }} atr치s
                        {% endif %}
                    </small></p>

                    <div class="comment-actions">
                        <button class="like-btn" data-id="{{ comentario.id }}">
                            <i class="fa fa-heart"></i> <span class="like-count">{{ comentario.likes.count }}</span>
                        </button>
                        <button class="reply-btn" data-id="{{ comentario.id }}">Reply</button>

                        {% if user == comentario.membro %}
                            <button class="edit-btn" data-id="{{ comentario.id }}">Edit</button>
                            <button class="delete-btn" data-id="{{ comentario.id }}">Delete</button>
                        {% endif %}
                    </div>

                    <div id="replies-{{ comentario.id }}" class="replies">
                        {% for resposta in comentario.replies %}
                            {{ resposta.comentario }}
                            <div class="reply-item">
                                <p><strong><a href="{% url 'membro-details' resposta.membro.id %}">{{ resposta.membro }}</a></strong>: {{ resposta.comentario }}</p>
                                <p><small>
                                    {% if resposta.publicado_em|timesince == "0 minutes" %}
                                        Agora mesmo
                                    {% else %}
                                        {{ resposta.publicado_em|timesince }} atr치s
                                    {% endif %}
                                </small></p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Favoritar jogo
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const gameId = this.dataset.gameId;
            fetch("{% url 'favoritar_jogo' %}", {
                method: 'POST',
                headers: { "X-CSRFToken": csrftoken },
                body: JSON.stringify({ game_id: gameId, favorito: !this.classList.contains('active') })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.classList.toggle('active');
                    this.querySelector('i').classList.toggle('far');
                    this.querySelector('i').classList.toggle('fas');
                }
            });
        });
    });

    // Avalia칞칚o
    document.querySelectorAll('.star-rating .star').forEach(star => {
        star.addEventListener('click', function () {
            const rating = parseInt(this.dataset.value) * 2;
            const gameId = this.parentNode.dataset.gameId;

            fetch("{% url 'avaliar_jogo' %}", {
                method: 'POST',
                headers: { "X-CSRFToken": csrftoken },
                body: JSON.stringify({ game_id: gameId, rating: rating })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.parentNode.dataset.currentRating = rating;
                }
            });
        });
    });

    // Enviar novo coment치rio
    const form = document.getElementById('game-comment-form');
    if (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const comentarioInput = document.getElementById('comentario-input');
            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'  // 游녣 ESSENCIAL para funcionar!!
                },
                body: new URLSearchParams({ comentario: comentarioInput.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    comentarioInput.value = '';
                    location.reload();
                }
            });
        });
    }

    // Curtir coment치rio
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const id = this.dataset.id;
            fetch(`/comentario/${id}/curtir/`, {
                method: 'POST',
                headers: { "X-CSRFToken": csrftoken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.querySelector('.like-count').textContent = data.likes;
                }
            });
        });
    });

    // Reply com toggle
    document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const commentId = this.dataset.id;
            const replyContainer = document.getElementById(`replies-${commentId}`);
            let replyBox = replyContainer.querySelector('.reply-box');

            if (replyBox) {
                replyBox.remove();
            } else {
                replyBox = document.createElement('div');
                replyBox.className = 'reply-box';
                const textarea = document.createElement('textarea');
                textarea.className = 'form-control';
                textarea.placeholder = 'Reply...';
                textarea.style.marginTop = '10px';

                const sendButton = document.createElement('button');
                sendButton.className = 'site-btn';
                sendButton.textContent = 'Send Reply';
                sendButton.style.marginTop = '5px';

                sendButton.addEventListener('click', function () {
                    const text = textarea.value.trim();
                    if (text) {
                        fetch(`/comentario/${commentId}/responder/`, {
                            method: 'POST',
                            headers: { "X-CSRFToken": csrftoken },
                            body: new URLSearchParams({ comentario: text })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const replyItem = `
                                    <div class="reply-item">
                                        <p><strong><a href="/membro/${data.membro_id}/">${data.membro}</a></strong>: ${data.comentario}</p>
                                        <p><small>${data.tempo}</small></p>
                                    </div>
                                `;
                                replyContainer.insertAdjacentHTML('afterbegin', replyItem);
                                replyBox.remove();
                            }
                        });
                    }
                });

                replyBox.appendChild(textarea);
                replyBox.appendChild(sendButton);
                replyContainer.prepend(replyBox);
            }
        });
    });

    // Editar coment치rio
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const commentId = this.dataset.id;
            const commentText = document.querySelector(`.comment-item[data-id="${commentId}"] .comentario-text`);
            const originalText = commentText.querySelector('textarea') ? commentText.querySelector('textarea').value.trim() : commentText.childNodes[0].nodeValue.trim();

            const textarea = document.createElement('textarea');
            textarea.className = 'form-control';
            textarea.value = originalText;

            const saveBtn = document.createElement('button');
            saveBtn.className = 'site-btn';
            saveBtn.textContent = 'Save';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'site-btn';
            cancelBtn.textContent = 'Cancel';

            commentText.innerHTML = '';
            commentText.appendChild(textarea);
            commentText.appendChild(saveBtn);
            commentText.appendChild(cancelBtn);

            saveBtn.addEventListener('click', function () {
                const newText = textarea.value.trim();
                fetch(`/comentario/${commentId}/editar/`, {
                    method: 'POST',
                    headers: { "X-CSRFToken": csrftoken },
                    body: new URLSearchParams({ comentario: newText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        commentText.innerHTML = newText;
                    }
                });
            });

            cancelBtn.addEventListener('click', function () {
                commentText.innerHTML = originalText;
            });
        });
    });

    // Deletar coment치rio
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            if (confirm("Are you sure you want to delete this comment?")) {
                const commentId = this.dataset.id;
                fetch(`/comentario/${commentId}/excluir/`, {
                    method: 'POST',
                    headers: { "X-CSRFToken": csrftoken }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`.comment-item[data-id="${commentId}"]`).remove();
                    }
                });
            }
        });
    });
});
</script>
<style>

   .comment-box button {
        display: inline-block;
        margin-right: 10px;
    }

    .replies {
        margin-left: 30px;
        margin-top: 10px;
        border-left: 2px solid #ccc;
        padding-left: 10px;
    }

    .reply-item {
        margin-top: 10px;
    }
    .reply-item p {
        margin: 0;
    }
    .reply-box textarea {
        width: 100%;
    }
    .reply-box button {
        display: inline-block;
        margin-right: 10px;
    }
</style>
{% include 'footer.html' %}
{% endblock %}
